function S4(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function InitAdapter(){return{}}function apiCall(e,t){if(Ti.Network.online){var i=Ti.Network.createHTTPClient({timeout:e.timeout||7e3});i.open(e.type,e.url),i.onload=function(){var e,o,l=!0;try{e=JSON.parse(i.responseText)}catch(a){Ti.API.error("[REST API] apiCall ERROR: "+a.message),l=!1,o=a.message}t({success:l,status:l?200==i.status?"ok":i.status:"error",code:i.status,data:o,responseText:i.responseText||null,responseJSON:e||null})},i.onerror=function(e){var o;try{o=JSON.parse(i.responseText)}catch(e){}t({success:!1,status:"error",code:i.status,data:e.error,responseText:i.responseText,responseJSON:o||null}),Ti.API.error("[REST API] apiCall ERROR: "+i.responseText),Ti.API.error("[REST API] apiCall ERROR CODE: "+i.status)};for(var o in e.headers)i.setRequestHeader(o,e.headers[o]);e.beforeSend&&e.beforeSend(i),i.send(e.data||null)}else t({success:!1,status:"offline",responseText:null})}function Sync(e,t,i){var o=t.config.debug;t.idAttribute=t.config.adapter.idAttribute||"id";var l=t.config.parentNode,a={create:"POST",read:"GET",update:"PUT","delete":"DELETE"},n=a[e],r=_.extend({},i);if(r.type=n,r.headers=r.headers||{},t.config.hasOwnProperty("headers"))for(header in t.config.headers)r.headers[header]=t.config.headers[header];if(!r.url&&(r.url=t.config.URL||t.url(),!r.url))return Ti.API.error("[REST API] ERROR: NO BASE URL"),void 0;switch(Alloy.Backbone.emulateJSON&&(r.contentType="application/x-www-form-urlencoded",r.processData=!0,r.data=r.data?{model:r.data}:{}),!Alloy.Backbone.emulateHTTP||"PUT"!==n&&"DELETE"!==n||(Alloy.Backbone.emulateJSON&&(r.data._method=n),r.type="POST",r.beforeSend=function(){r.headers["X-HTTP-Method-Override"]=n}),r.headers["Content-Type"]="application/json",logger(o,"REST METHOD",e),e){case"create":r.data=JSON.stringify(t.toJSON()),logger(o,"create options",r),apiCall(r,function(e){if(e.success){var i=parseJSON(o,e,l);void 0==i[t.idAttribute]&&(i[t.idAttribute]=guid()),r.success(i,JSON.stringify(i)),t.trigger("fetch")}else r.error(e.responseJSON,e.responseText),Ti.API.error("[REST API] CREATE ERROR: "),Ti.API.error(e)});break;case"read":t[t.idAttribute]&&(r.url=r.url+"/"+t[t.idAttribute]),r.urlparams&&(r.url=encodeData(r.urlparams,r.url)),logger(o,"read options",r),apiCall(r,function(e){if(e.success){var i=parseJSON(o,e,l),a=[];t.length=0;for(var n in i){var s={};s=i[n],void 0==s[t.idAttribute]&&(s[t.idAttribute]=guid()),a.push(s),t.length++}r.success(1===t.length?a[0]:a,e.responseText),t.trigger("fetch")}else r.error(e.responseJSON,e.responseText),Ti.API.error("[REST API] READ ERROR: "),Ti.API.error(e)});break;case"update":if(!t[t.idAttribute])return r.error(null,"MISSING MODEL ID"),Ti.API.error("[REST API] ERROR: MISSING MODEL ID"),void 0;if(-1==_.indexOf(r.url,"?"))r.url=r.url+"/"+t[t.idAttribute];else{var s=r.url.split("?");r.url=s[0]+"/"+t[t.idAttribute]+"?"+s[1]}r.urlparams&&(r.url=encodeData(r.urlparams,r.url)),r.data=JSON.stringify(t.toJSON()),logger(o,"update options",r),apiCall(r,function(e){if(e.success){var i=parseJSON(o,e,l);r.success(i,JSON.stringify(i)),t.trigger("fetch")}else r.error(e.responseJSON,e.responseText),Ti.API.error("[REST API] UPDATE ERROR: "),Ti.API.error(e)});break;case"delete":if(!t[t.idAttribute])return r.error(null,"MISSING MODEL ID"),Ti.API.error("[REST API] ERROR: MISSING MODEL ID"),void 0;r.url=r.url+"/"+t[t.idAttribute],logger(o,"delete options",r),apiCall(r,function(e){e.success?(parseJSON(o,e,l),r.success(null,e.responseText),t.trigger("fetch")):(r.error(e.responseJSON,e.responseText),Ti.API.error("[REST API] DELETE ERROR: "),Ti.API.error(e))})}}function logger(e,t,i){e&&(Ti.API.debug("[REST API] "+t),Ti.API.debug(i))}function parseJSON(e,t,i){var o=t.responseJSON;return _.isUndefined(i)||(o=_.isFunction(i)?i(o):traverseProperties(o,i)),logger(e,"server response",o),o}function traverseProperties(e,t){var o=t.split(".");for(i=0,l=o.length;l>i;i++)e=e[o[i]];return e}function encodeData(e,t){var i=[];for(var o in e)i.push(Ti.Network.encodeURIComponent(o)+"="+Ti.Network.encodeURIComponent(e[o]));return-1==_.indexOf(t,"?")?t+"?"+i.join("&"):t+"&"+i.join("&")}var _=require("alloy/underscore")._,Alloy=require("alloy"),Backbone=Alloy.Backbone;module.exports.sync=Sync,module.exports.beforeModelCreate=function(e){return e=e||{},InitAdapter(e),e},module.exports.afterModelCreate=function(e){return e=e||{},e.prototype.config.Model=e,e.prototype.idAttribute=e.prototype.config.adapter.idAttribute,e};